{% extends 'base.html' %}
{% block nav_item_changeorder %}active{% endblock nav_item_changeorder %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="{% static 'upload_download_files.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="{% static 'upload_download_files.js' %}"></script>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title>Trinity GP</title>
    <link rel="shortcut icon" type="image/png" href="/media/images/favicon.png">
    <link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="http://www.datatables.net/rss.xml">
    <link rel="stylesheet" type="text/css" href="/media/css/site-examples.css?_=8f7cff5ee7757412879aedf3efbfaee01">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
    <style type="text/css" class="init">
        .list-items {
        border-bottom: 1px solid black; display: flex; justify-content: space-between;
        }
        #folderList {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #3f50b5;
            border-radius: 2px;
        }
    </style>

    <script type="text/javascript" src="/media/js/site.js?_=1d5abd169416a09a2b389885211721dd"
            data-domain="datatables.net" data-api="https://plausible.sprymedia.co.uk/api/event"></script>
    <script src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
    <script type="text/javascript" src="/media/js/dynamic.php?comments-page=examples%2Fadvanced_init%2Fevents_live.html"
            async></script>
    <script type="text/javascript" src="/media/js/dynamic.php?comments-page=examples%2Fdata_sources%2Fdom.html"
            async></script>
    <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script type="text/javascript" language="javascript"
            src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript" src="../resources/demo.js"></script>
    <script type="text/javascript" class="init">
        let dropArea = document.getElementById("drop-area")
        function Previous() {
        window.history.back()
        }
        function check_booking_data1(){
            if (document.getElementById("is_approved_to_bill").checked){
                if (document.getElementById("gc_number").value == ""){
                    if (document.getElementById("approval_note").value == ""){
                        alert("You must either provide a GC number, or provide an explanation")
                        return false
                    }
                }
            }
            else {
                    if (document.getElementById("approval_note").value == ""){
                        alert("You must provide an explanation")
                        return false
                    }
            }
        }


        function check_booking_data(){
            var notes_section = document.getElementById("no_tm_notes")
            var name=prompt("Please clarify why you changed this");
            if (name!=null){
                notes_section.value = name;
            }
        }
        function void_notes1(where){
            var notes_section = document.getElementById(where)
            var name=prompt("Please clarify");
            if (name!=null){
                notes_section.value = name;
            }
        }
function prompt_note(){
            var name=prompt("Note:");
            if (name!=null){
            note_input.new_note.value = name
            note_input.submit()
            }
}
    </script>
</head>
<body>
<nav class="sub-nav navbar navbar-expand-sm navbar-dark bg-dark">
    <a class="navbar-brand sub-navbar-brand" href="#">Change Orders</a>
    <div id="navbarNavDropdown2">
        <ul class="sub-nav-list navbar-nav ">
            <li><a class="nav-item nav-link" href="{% url 'change_order_home' %}">Home</a></li>
            <li><a class="nav-item nav-link" href="{% url 'change_order_new' 'ALL' %}">Add New</a></li>
            <li><a class="nav-item nav-link active" href="#">{{changeorder.job_number}} Change Order:
                #{{changeorder.cop_number}}</a></li>

        </ul>
    </div>
</nav>
<!-- Modal -->
<div class="modal fade" id="changeOrderFolderModal" tabindex="-1" role="dialog" aria-labelledby="title"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="title3"></h5>
                <button onclick="location.reload();" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="folderList"></div>
                <div id="drop-area" ondragenter="preventDefaults(event)" ondragover="highlight(event)" ondragleave="unhighlight(event)" ondrop="handleDrop(event, '/changeorder/uploadFile', {{changeorder.id}}, '/changeorder/getChangeorderFolder')">
                  <form class="my-form">
                    <p>Upload multiple files with the file dialog or by dragging and dropping images onto the dashed region</p>
                    <input type="file" id="fileElem" multiple onchange="handleFiles(this.files, '/changeorder/uploadFile', {{changeorder.id}}, '/changeorder/getChangeorderFolder')">
                    <label class="button" for="fileElem">Select some files</label>
                  </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="location.reload();" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div class="container" style="margin-bottom: 20px;">
    <h4 style="text-align: center" class="h4">{{changeorder.job_number.job_number}} - {{changeorder.job_number.job_name}} </h4>
        <h4 style="text-align: center" class="h4">Change Order #{{changeorder.cop_number}}</h4>
        <h4 style="text-align: center" class="h4">{{changeorder.description}}</h4>
    <div class="row h-100 w-100 d-flex justify-content-left">
        <div style="padding: 5px" class="form-group">
            <form action="{% url 'job_page' changeorder.job_number.job_number %}">
                {% csrf_token %}
                <input type="submit" style="width=250px" class="btn btn-info btn-sm" name="goto_job"
                       value="Go To Job Page"/>
            </form>
        </div>
        <div style="padding: 5px" class="form-group">

            <input data-toggle="modal" onclick="getFolderContents({{changeorder.id}}, '/changeorder/getChangeorderFolder')" data-target="#changeOrderFolderModal" type="submit" style="width=250px" class="btn btn-primary btn-sm" name="open_folder"
                   value="Open Change Order Folder to View Files"/>

        </div>
    </div>
</div>
    <br>
<div class="container">
<div id="accordion">
    <div class="card">
        <div class="card-header" id="headingZero" style="background-color:hsla(128,100%, 80%);">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseZero" aria-expanded="false"
                        aria-controls="collapseZero">
                    Files and Attachments
                </button>
            </h5>
        </div>
        <div id="collapseZero" class="collapse hide" aria-labelledby="headingZero" data-parent="#accordion">
            <div class="card-body">
                <div class="container row">
                        <div class="col-12">
                            <font color="red">Upload Documents (Pictures, Invoice, Etc.) For This Change Order</font>
                            <form action="{% url 'extra_work_ticket' changeorder.id %}" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="input-group">
                                  <input type="file" class="form-control" name="upload_file" id="upload_file" aria-describedby="inputGroupFileAddon04" aria-label="Upload">
                                  <input class="btn btn-outline-secondary" type="submit" value="Upload File" id="inputGroupFileAddon04" />
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            {% if no_folder_contents %}
                            <font color="red">No documents exist yet for this change order</font>
                            {% else %}
                            <font color="red">Here are the documents that have been uploaded for this change order</font>
                            <ul>
                                {% for x in foldercontents %}
                                <li>

                                    <div class="col-12">
                                        <a style="color: blue; cursor: pointer;" name="get_directory_contents"
                                           href="{% url 'get_directory_contents' changeorder.id x 'changeorder' %}" target="_blank">{{x}}</a>
                                        <br>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header" id="headingOne" style="background-color:hsla(128,100%, 80%);">
            <h5 class="mb-0">
                <button class="btn btn-link" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false"
                        aria-controls="collapseOne">
                    Notes
                </button>
            </h5>
        </div>
        <div id="collapseOne" class="collapse hide" aria-labelledby="headingOne" data-parent="#accordion">
            <div class="card-body">
                <div class="row">
                        <div class="col-12">
                            {% if notes %}
                            <h5>NOTES</h5>

                            {% for note in notes %}
                            <h7>[{{note.date}}- {{note.user}}] {{note.note}}</h7>
                            <br>
                            {% endfor %}
                            {% endif %}
                            <br>
                            <form name='note_input' action="{% url 'extra_work_ticket' changeorder.id %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="new_note" id="new_note" value=""/>
                                <button type="button" class="btn btn-primary btn-sm" onclick="prompt_note()">Add a Note </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
</div>
</div>
<div class="container">
    {% if changeorder.is_closed == True %}
    <h1>VOIDED</h1>
    {% else %}
    {% if changeorder.is_t_and_m == True %}
    {% if changeorder.need_ticket == "Yes" %}
    <h1>Ticket Required</h1>
    <form action="{% url 'process_ewt' changeorder.id %}">
        <input type="submit" class="btn btn-secondary btn-sm" value="Fill Out Ticket Now"/>
    </form>
    {% else %}
    {% if changeorder.is_ticket_signed == False %}
    {% if changeorder.is_printed == False %}
    <form action="{% url 'print_ticket' changeorder.id 'OLD' %}" ><input type="submit" class="btn btn-secondary btn-sm" value="Print Ticket for Ink Signature"/></form>
    {% else %}
    <form action="{% url 'print_ticket' changeorder.id 'OLD' %}" ><input type="submit" class="btn btn-secondary btn-sm"
                  value="Ticket Already Printed. Click to Print Again"/></form>
    {% endif %}
    <br>
    <form action="{% url 'print_ticket' changeorder.id 'NEW' %}" ><input type="submit" value="Get Digital Signature"/></form>
    <br>
    <form action="{% url 'process_ewt' changeorder.id %}"><input type="submit" value="View / Change Ticket"/>
    </form>
    <br>
    {% endif %}
    {% if changeorder.need_ticket_signed == "Yes" %}
    <h1>Ticket Created, Not Signed</h1>
    <form action="{% url 'extra_work_ticket' changeorder.id %}" method="post"
          onSubmit="void_notes1('signed_notes')">
        {% csrf_token %}
        <input type="hidden" name="signed_notes" id="signed_notes"/><input class="btn btn-secondary btn-sm"
                                                                           type="submit" name='signed'
                                                                           value="Ticket Signed"/></form>
    <br>
    <form action="{% url 'price_ewt' changeorder.id %}"><input class="btn btn-secondary btn-sm" type="submit"
                                                               value="Send Price Now, Without Signed Ticket"/>
    </form>
    {% endif %}
    {% endif %}
    {% endif %}
    {% if changeorder.date_sent == None %}
    {% if changeorder.is_t_and_m == True %}
    {% if changeorder.need_ticket == "No" and changeorder.need_ticket_signed == "No" %}
    <h1>Change Order Not Sent Yet</h1><br>
    <form action="{% url 'price_ewt' changeorder.id %}"><input class="btn btn-secondary btn-sm" type="submit"
                                                               value="Send TM Price Now"/></form>
    {% endif %}
    {% else %}
    <h1>Change Order Not Sent Yet</h1><br>
    <form action="{% url 'change_order_send' changeorder.id %}">
        <input class="btn btn-secondary btn-sm" type="submit" style="margin-bottom: 5px" value="Send Now"/></form>
    {% endif %}
    {% else %}
    {% if changeorder.is_approved == True %}
    <h1>Change Order Approved</h1>
    <h3> Date Sent: {{changeorder.date_sent}}</h3>
    <h3> Date Approved: {{changeorder.date_approved}}</h3>
    <h3>Price: ${{changeorder.price}}</h3>
    <h3>GC #: {{changeorder.gc_number}}</h3>
    {% else %}
    <h1>Change Order Sent</h1>
    {% if changeorder.is_t_and_m == True %}
    <form action="{% url 'preview_TMProposal' tmproposal.id %}">
        <input type="submit" class="btn btn-secondary btn-sm" style="margin-bottom: 5px" name="view_proposal" value="View Proposal"/></form>
    {% else %}
    <form action="{% url 'preview_TMProposal' changeorder.id %}">
        <input type="submit" class="btn btn-secondary btn-sm" name="view_proposal" value="View Proposal(need to code)"/>
    </form>
    {% endif %}
    <h3> Date Sent: {{changeorder.date_sent}}</h3>
    <h3>Price: ${{changeorder.price}}</h3>
    <h5>Scope: {{changeorder.full_description}}</h5>
    <form name='approval_input' action="{% url 'extra_work_ticket' changeorder.id %}" method="post"
          onSubmit="return check_booking_data1()">
        {% csrf_token %}
        <input type="checkbox" name="is_approved_to_bill" id="is_approved_to_bill"/> <label
            for="is_approved_to_bill">"Is
        this Approved for Billing?" </label><br>
        <label for="approved_price">Approved Price: $</label><input type="text" name="approved_price"
                                                                    id="approved_price"
                                                                    value={{changeorder.price}} size="30"
                                                                    required/><br>
        <label for="gc_number">GC Formal Number: </label><input type="text" name="gc_number" id="gc_number"
                                                                size="10"/><br>
        <label for="approval_note">Please provide any notes about this approval: </label> <br>
        <textarea id="approval_note" name="approval_note" rows="2" cols="100"></textarea><br>
        <input type="submit" class="btn btn-secondary btn-sm" name='submit_form1' value="Approve Now!"/></form>
    <br>
    <form action="{% url 'change_order_send' changeorder.id %}"><input class="btn btn-secondary btn-sm" type="submit"
                                                                       name='edit_co'
                                                                       value="Edit Change Order"/></form>
    <hr>
    {% endif %}
    {% endif %}
    {% endif %}
    <form name='change_tm' action="{% url 'extra_work_ticket' changeorder.id %}" method="post"
          onSubmit="return check_booking_data()">
        {% csrf_token %}
        <input type="hidden" id="no_tm" name="no_tm" value="Yes"/>
        <input type="hidden" id="no_tm_notes" name="no_tm_notes" value="None"/>
        {% if changeorder.is_t_and_m == True %}
        <input type="submit" class="btn btn-secondary btn-sm" name='submit_form3'
               value="Price Required, No Longer T&M"/>

        {% else %}
        <input style="margin-bottom: 5px;" type="submit" class="btn btn-secondary btn-sm" name='submit_form3' value="Change to T&M"/>
        {% endif %}
    </form>
    <form name='void_input' action="{% url 'extra_work_ticket' changeorder.id %}" method="post"
          onSubmit="void_notes1('void_notes')">
        {% csrf_token %}
        <input style="margin-bottom: 5px;" type="hidden" name="void_notes" id="void_notes"/>
        <input style="margin-bottom: 5px;" type="submit" class="btn btn-secondary btn-sm" name='submit_form4' {% if changeorder.is_closed == True %}value="RE-OPEN"{% else %} value="VOID" {% endif %}/>
    </form>
    <button style="margin-bottom: 5px;" class="btn btn-primary btn-sm" onclick="Previous()">Back to Previous Page</button>
</div>
</body>
</html>

{% endblock %}
