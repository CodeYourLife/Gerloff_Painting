{% extends 'base.html' %}
{% load static %}
{% block extra_head %}

<style>

/* ==========================================
   FILE ATTACHMENT STYLE
========================================== */

.file-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 6px;
    background-color: #f1f3f5;
    border: 1px solid #d6d8db;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    font-size: 13px;
}

.file-pill:hover {
    background-color: #e2e6ea;
    border-color: #adb5bd;
    transform: translateY(-1px);
}

.file-icon {
    font-size: 14px;
}

.file-name {
    font-weight: 500;
    color: #212529;
}


/* ==========================================================
   GLOBAL TABLE + DATATABLES
========================================================== */

#notes_table thead {
    display: none;
}

.dataTables_wrapper {
    font-family: Tahoma, sans-serif;
    font-size: 13px;
}

.dataTables_filter {
    float: left !important;
}

tr th {
    width: fit-content !important;
}

.colored-header th {
    background-color: #cfe2ff;
    padding: 6px;
    border: 1px solid #777;
}

/* ==========================================================
   NAVIGATION
========================================================== */

nav .active,
.collapsible:hover {
    background-color: #dc3545 !important;
    color: #fff !important;
    border-radius: 4px;
}

.nav-pills li {
    padding: 2px;
}

.nav-pills a {
    color: #000;
}

.nav-pills .active {
    background-color: #6c757d !important;
    padding: 5px;
}

/* ==========================================================
   FORM ELEMENTS
========================================================== */

label {
    margin: 0 10px;
}

input,
textarea,
select {
    margin: 0 10px;
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
}

.small-note {
    font-size: 13px;
    color: #666;
}

/* ==========================================================
   TABLE STYLING
========================================================== */

.tb {
    border-collapse: collapse;
    width: 300px;
}

.tb th,
.tb td {
    padding: 6px;
    border: 1px solid #777;
}

.tb th {
    background-color: #cfe2ff;
}

.text-wrap {
    white-space: normal;
}

.width-200 {
    width: 200px;
}

/* ==========================================================
   MODAL + FILE LIST
========================================================== */

.modal-content {
    border-radius: 8px;
}

#folderList {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #3f50b5;
    border-radius: 4px;
    padding: 10px;
}

/* ==========================================================
   DRAG & DROP AREA
========================================================== */

#drop-area {
    border: 2px dashed #aaa;
    padding: 25px;
    text-align: center;
    border-radius: 8px;
    transition: all 0.2s ease;
    background: #fafafa;
}

#drop-area.drag-active {
    background: #eef6ff;
    border-color: #007bff;
}

/* ==========================================================
   TICKET CARDS
========================================================== */

.ticket-card {
    background: #ffffff;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.ticket-card h5 {
    font-weight: 600;
    margin-bottom: 15px;
}

.ticket-card .btn {
    margin: 5px 8px 5px 0;
}

/* ==========================================================
   STATUS BAR
========================================================== */

.ticket-status-wrapper {
    width: 100%;
    margin: 20px 0;
}

.ticket-status-centered {
    text-align: center;
    padding: 14px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 16px;
    letter-spacing: 0.3px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.06);
}

/* STATUS COLORS */

.status-gray {
    background: #e9ecef;
    color: #495057;
}

.status-info {
    background: #d1ecf1;
    color: #0c5460;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
}

.status-success {
    background: #d4edda;
    color: #155724;
}

.status-danger {
    background: #f8d7da;
    color: #721c24;
}

/* ==========================================================
   CLEAN CARD (GENERIC UTILITY)
========================================================== */

.clean-card {
    background: #ffffff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.clean-card-header {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
}

.section-divider {
    margin: 20px 0;
}

/* ==========================================================
   FLEX UTILITIES
========================================================== */

.gap-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.list-items {
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
}

</style>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.1/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="{% static 'project_styles.css' %}">

{% endblock %}
{% block extra_scripts %}

<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.7/sorting/datetime-moment.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    /* ==========================================================
       DATATABLE SAFE INITIALIZATION
    ========================================================== */
    const tableIds = ['approved_table', 'pending_table', 'formals_table'];

    tableIds.forEach(id => {
        const el = document.getElementById(id);
        if (el && $.fn.DataTable && !$.fn.DataTable.isDataTable('#' + id)) {
            $('#' + id).DataTable({
                paging: false,
                info: false,
                ordering: false,
                searching: false
            });
        }
    });

    /* ==========================================================
       HIDE OPTIONAL SECTIONS
    ========================================================== */
    toggleDisplay("hidden_section_add", false);
    toggleDisplay("hidden_section_change", false);

    /* ==========================================================
       ALERT MESSAGES (ONLY IF VALUE EXISTS)
    ========================================================== */
    showAlertIfValue("{{email_success}}", "Email successfully sent!");
    showAlertIfValue("{{email_failed}}", "Email failed to send!");
    showAlertIfValue("{{error_message}}", "{{error_message}}");

    /* ==========================================================
       DRAG & DROP (MODAL SAFE + MULTI FILE)
    ========================================================== */
    const dropArea = document.getElementById("drop-area");
    const fileInput = document.getElementById("fileElem");

    if (dropArea) {

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
            dropArea.addEventListener(event, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(event => {
            dropArea.addEventListener(event, () => dropArea.classList.add("drag-active"), false);
        });

        ['dragleave', 'drop'].forEach(event => {
            dropArea.addEventListener(event, () => dropArea.classList.remove("drag-active"), false);
        });

        dropArea.addEventListener("drop", function (e) {
            const files = e.dataTransfer.files;
            if (files.length) uploadFiles(files);
        });
    }

    if (fileInput) {
        fileInput.addEventListener("change", function () {
            if (this.files.length) uploadFiles(this.files);
        });
    }

});

/* ==========================================================
   DRAG/DROP HELPERS
========================================================== */

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function uploadFiles(files) {

    const formData = new FormData();

    for (let i = 0; i < files.length; i++) {
        formData.append("upload_file", files[i]);
    }

    fetch("{% url 'upload_changeorder_file' changeorder.id %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert("Upload failed.");
        }
    })
    .catch(() => alert("Upload error."));
}

/* ==========================================================
   SMALL UTILITIES
========================================================== */

function toggleDisplay(id, show) {
    const el = document.getElementById(id);
    if (el) el.style.display = show ? "block" : "none";
}

function showAlertIfValue(value, message) {
    if (value && value !== "None" && value !== "") {
        alert(message);
    }
}

/* ==========================================================
   GENERAL FUNCTIONS
========================================================== */

function Previous() {
    window.history.back();
}

function copyChangeOrderPath() {
    const input = document.getElementById("changeOrderPath");
    if (!input) return;

    input.select();
    input.setSelectionRange(0, 99999);

    try {
        document.execCommand("copy");
        alert("Folder path copied to clipboard");
    } catch {
        alert("Copy not supported in this browser");
    }
}

function check_booking_data1() {

    const approved = document.getElementById("is_approved_to_bill");
    const gcNumber = document.getElementById("gc_number");
    const note = document.getElementById("approval_note");

    if (!approved || !note) return true;

    if (approved.checked) {
        if (!gcNumber.value && !note.value) {
            alert("Provide a GC number or explanation.");
            return false;
        }
    } else {
        if (!note.value) {
            alert("You must provide an explanation.");
            return false;
        }
    }
}

function check_booking_data() {
    const field = document.getElementById("no_tm_notes");
    const msg = prompt("Please clarify why you changed this");
    if (msg && field) field.value = msg;
}

function void_notes1(id) {
    const field = document.getElementById(id);
    const msg = prompt("Please clarify");
    if (msg && field) field.value = msg;
}

function prompt_note() {
    const msg = prompt("Note:");
    if (msg && document.note_input) {
        document.note_input.new_note.value = msg;
        document.note_input.submit();
    }
}

function check_paper_ticket() {
    const fileInput = document.getElementById("upload_file2");
    if (fileInput && !fileInput.value) {
        alert("You must upload a copy of the signed ticket");
        return false;
    }
}

/* ==========================================================
   FILE SELECTION
========================================================== */

function populate_file_form(fileName) {

    if (document.select_file_form) {
        document.select_file_form.selected_file.value = fileName;
        document.select_file_form.submit();
    }
}

/* ==========================================================
   RECIPIENT LOGIC
========================================================== */

function populate_ticket_recipient() {

    const form = document.select_recipient_form;
    if (!form) return;

    const selected = form.recipient.value;
    const addSection = document.getElementById("hidden_section_add");
    const changeSection = document.getElementById("hidden_section_change");

    if (selected === "please_select" || selected === "add_new") {

        form.recipient_name.value = "";
        form.recipient_email.value = "";
        form.recipient_phone.value = "";

        toggleDisplay("hidden_section_add", selected === "add_new");
        toggleDisplay("hidden_section_change", false);

        return;
    }

    toggleDisplay("hidden_section_add", false);
    toggleDisplay("hidden_section_change", false);

    const rolodex = JSON.parse("{{client_list_json|escapejs}}");

    rolodex.forEach(person => {
        if (person.person_pk == selected) {
            form.recipient_name.value = person.name;
            form.recipient_email.value = person.email;
            form.recipient_phone.value = person.phone;
        }
    });
}

function check_for_new() {

    const form = document.select_recipient_form;
    if (!form) return;

    const selected = form.recipient.value;
    const rolodex = JSON.parse("{{client_list_json|escapejs}}");

    if (selected === "please_select") {
        form.recipient.value = "add_new";
        toggleDisplay("hidden_section_add", true);
        return;
    }

    if (selected === "add_new") return;

    let changed = false;

    rolodex.forEach(person => {
        if (person.person_pk == selected) {
            if (form.recipient_name.value !== person.name) changed = true;
            if (form.recipient_email.value !== person.email) changed = true;
            if (form.recipient_phone.value !== person.phone) changed = true;
        }
    });

    toggleDisplay("hidden_section_change", changed);
}

function send_ticket_email() {

    const form = document.select_recipient_form;
    if (!form) return false;

    if (form.recipient.value === "please_select") {
        alert("Change Drop Down Menu");
        return false;
    }

    alert("Please wait until the email notification appears.");
}

/* ==========================================================
   YES / NO TOGGLE BUTTONS
========================================================== */

function toggleButtonPair(yesId, noId, fieldName, value) {

    const yesBtn = document.getElementById(yesId);
    const noBtn = document.getElementById(noId);

    if (!yesBtn || !noBtn || !document.select_recipient_form) return;

    yesBtn.style.background = value === "Yes" ? "red" : "black";
    noBtn.style.background = value === "No" ? "red" : "black";

    document.select_recipient_form[fieldName].value = value;
}

function yes_add() { toggleButtonPair('yes_add_button','no_add_button','add_recipient_form','Yes'); }
function no_add() { toggleButtonPair('yes_add_button','no_add_button','add_recipient_form','No'); }
function yes_change() { toggleButtonPair('yes_change_button','no_change_button','change_recipient_form','Yes'); }
function no_change() { toggleButtonPair('yes_change_button','no_change_button','change_recipient_form','No'); }

</script>


{% endblock %}
{% block nav_item_changeorder %}active{% endblock nav_item_changeorder %}
{% block content %}



<nav class="sub-nav navbar navbar-expand-sm navbar-dark bg-dark">
    <a class="navbar-brand sub-navbar-brand" href="#">Change Orders</a>
    <div id="navbarNavDropdown2">
        <ul class="sub-nav-list navbar-nav ">
            <li><a class="nav-item nav-link" href="{% url 'change_order_home' %}">Home</a></li>
            <li><a class="nav-item nav-link" href="{% url 'change_order_new' 'ALL' %}">Add New</a></li>
            <li><a class="nav-item nav-link active" href="#">{{changeorder.job_number}} Change Order:
                #{{changeorder.cop_number}}</a></li>

        </ul>
    </div>
</nav>

<!-- Modal - select email recipient -->
<div class="modal fade" id="email_approval_modal" tabindex="-1" role="dialog" aria-labelledby="title"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="title3"></h5>
                <button onclick="location.reload();" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="select_recipient_form" action="{% url 'extra_work_ticket' changeorder.id %}" method="post" onSubmit = "return send_ticket_email()" >
                    {% csrf_token %}
                    <b>Who do you want to email the ticket to?</b>
                    <br>
                     <select id="recipient" name="recipient" onchange="populate_ticket_recipient()">
                         <option value="please_select">Please Select Person</option>
                         <option value="add_new">Add New</option>
                     {% for x in client_list %}
                    {% if x.is_active %}
                         <option value={{x.person_pk}}>{{x.name}}</option>
                    {% endif %}
                    {% endfor %}
                     </select>
                    <br>
                    <input type="text" name="recipient_name" id="recipient_name" placeholder="Recipient Name" required onchange="check_for_new()"/>
                    <input type="email" name="recipient_email" id="recipient_email" placeholder="Recipient Email" required onchange="check_for_new()"/>
                    <input type="phone" name="recipient_phone" id="recipient_phone" placeholder="Recipient Phone" onchange="check_for_new()"/>
                    <input type="hidden" id="change_recipient_form" name="change_recipient_form" value="NA">
                    <input type="hidden" id="add_recipient_form" name="add_recipient_form" value="NA">
                    <div id="hidden_section_change">
                        <b>Do you want to permanently change this person's info?</b><br>
                        <button type="button" id="yes_change_button" onclick = "yes_change()" class="btn btn-primary btn-sm" >Yes</button>
                        <button type="button" id="no_change_button" onclick = "no_change()" class="btn btn-primary btn-sm" >No</button>
                    </div>
                    <div id="hidden_section_add">
                        <b>Do you want to add this person as a contact?</b><br>
                        <button type="button" id="yes_add_button" onclick = "yes_add()" class="btn btn-primary btn-sm" >Yes</button>
                        <button type="button" id="no_add_button" onclick = "no_add()" class="btn btn-primary btn-sm" >No</button>
                    </div>
            </div>
            <div class="modal-footer">
                <div id="hidden-element"></div>
                <input type="submit" value="Email Now" class="btn btn-primary" name="email_now"/>
                </form>
                <button type="button" class="btn btn-secondary" onclick="location.reload();" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!--upload files modal-->
<div class="modal fade" id="changeOrderFolderModal" tabindex="-1" role="dialog" aria-labelledby="title"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="title3"></h5>
                <button onclick="location.reload();" type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="drop-area" class="drop-zone">
                    <form class="my-form">
                        <p>Upload multiple files by dragging them here</p>

                        <input type="file"
                               id="fileElem"
                               multiple>

                        <label class="btn btn-primary btn-sm mt-2" for="fileElem">
                            Select Files
                        </label>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <div id="hidden-element"></div>
                <button type="button" class="btn btn-secondary" onclick="location.reload();" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!-- view all change orders for this job-->
<div class="modal fade" id="changes-modal" tabindex="-1" role="dialog" aria-labelledby="title"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="title2"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-pills">
                    <li>
                    <a href="#7a" class="active" data-toggle="tab">Approved</a>
                    </li>
                    <li><a href="#8a" data-toggle="tab">Pending</a>
                    </li>
                    <li><a href="#9a" data-toggle="tab">Formals</a>
                    </li>
                </ul>
                <div class="tab-content clearfix">
                    <div class="tab-pane active" id="7a">
                        <div style="margin-top: 12px" class="table-responsive">
                            <div id="approved_tab">
                                <table id="approved_table">
                                    <thead>
                                    <tr>
                                        <th>COP #</th>
                                        <th>Description</th>
                                        <th>Price</th>
                                        <th>GC #</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for x in approved %}
                                    <tr>
                                        <td>{{x.cop_number}}</td>
                                        <td>{{x.description}}</td>
                                        <td>${{x.price}}</td>
                                        <td>{{x.gc_number}}</td>
                                    </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="8a">
                        <div style="margin-top: 12px" class="table-responsive">
                            <div id="pending_tab">
                                <table id="pending_table">
                                    <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Description</th>
                                        <th>Price</th>
                                        <th>GC #</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for x in pending %}
                                    <tr>
                                        <td>{{x.cop_number}}</td>
                                        <td>{{x.description}}</td>
                                        <td>${{x.price}}</td>
                                        <td>{{x.gc_number}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane" id="9a">
                        <div style="margin-top: 12px" class="table-responsive">
                            <div id="formals_tab">
                                <table id="formals_table">
                                    <thead>
                                    <tr>
                                        <th>GC #</th>
                                        <th>Description</th>
                                        <th>Total</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for x in formals %}
                                    <tr>
                                        <td>{{x.gc_number}}</td>
                                        <td>{{x.description}}</td>
                                        <td>{{x.total}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick = "anothertest()" data-dismiss="modal" > Save Changes </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal -upload ticket -->
<div class="modal fade" id="signed_ticket-modal" tabindex="-1" role="dialog" aria-labelledby="title"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="title3">Upload Signed Ticket</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                            <form action="{% url 'extra_work_ticket' changeorder.id %}" method="post" enctype="multipart/form-data" onSubmit="return check_paper_ticket()" >
                                {% csrf_token %}
                                <div class="input-group">
                                  <input type="file" class="form-control" name="upload_file2" id="upload_file2" aria-describedby="inputGroupFileAddon04" aria-label="Upload">
                                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <input type="submit" class="btn btn-primary btn-sm" value="Save Now" id="inputGroupFileAddon04" />
<!--                <button type="button" class="btn btn-primary" data-dismiss="modal">Save Now</button>-->
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal -select post bid docs -->
<div
  class="modal fade"
  id="folderSelectModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="folderSelectModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">

      <form method="post">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title" id="folderSelectModalLabel">
            üìÅ Select Job Subfolders
          </h5>
          <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
          </button>
        </div>

        <div class="modal-body">

          {% if post_bid_doc_folders %}
            <p class="text-muted mb-2">
              Job folder:
              <code>{{ job_base_path }}</code>
            </p>

            {% for folder in post_bid_doc_folders %}
              <div class="form-check mb-2">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="folders"
                  id="folder_{{ forloop.counter }}"
                  value="{{ folder.path }}"
                >
                <label
                  class="form-check-label"
                  for="folder_{{ forloop.counter }}"
                >
                  üìÅ {{ folder.name }}
                </label>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-danger">
              No subfolders found for this job.
            </p>
          {% endif %}

        </div>

        <div class="modal-footer">
          <button type="submit" class="btn btn-primary" name="create_post_bid_doc_shortcuts">
            Continue
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            data-dismiss="modal"
          >
            Cancel
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<!-- HEADER -->
<div class="container-ticket section-card text-center">

    <div class="mb-3">
        <div class="ticket-title">
            {{ changeorder.job_number.job_number }} ‚Äì {{ changeorder.job_number.job_name }}
        </div>

        <div class="h5 font-weight-semibold mt-2">
            Change Order #{{ changeorder.cop_number }}
        </div>

        <div class="text-muted mt-1">
            {{ changeorder.description }}
        </div>
    </div>

    <div class="d-flex flex-wrap justify-content-center gap-buttons">

        <form action="{% url 'job_page' changeorder.job_number.job_number %}" class="m-2">
            {% csrf_token %}
            <button type="submit" class="btn btn-info btn-sm px-4">
                Go To Job Page
            </button>
        </form>

        <button
            data-toggle="modal"
            onclick="getFolderContents({{changeorder.id}}, '/changeorder/getChangeorderFolder')"
            data-target="#changeOrderFolderModal"
            class="btn btn-info btn-sm m-2 px-4">
            Batch Upload Files
        </button>

        <button
            data-toggle="modal"
            data-target="#changes-modal"
            class="btn btn-info btn-sm m-2 px-4">
            View All Change Orders
        </button>

    </div>

</div>

<div class="container">
<!-- ACCORDION - files and notes -->
<div class="container-ticket">

<div id="accordion">

<!-- =========================
     FILES & ATTACHMENTS
========================= -->
<div class="clean-card">
    <div class="clean-card-header">
        üìÅ Files & Attachments
    </div>

    <div class="mb-3 small-note">
        Upload documents (pictures, invoices, etc.) for this change order
    </div>

    <form action="{% url 'extra_work_ticket' changeorder.id %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="input-group">
            <input type="file" class="form-control" name="upload_file">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary btn-sm" type="submit">
                    Upload
                </button>
            </div>
        </div>
    </form>

    <div class="section-divider"></div>

    {% if no_folder_contents %}
        <div class="small-note">No documents uploaded yet.</div>
    {% else %}
        <div class="small-note mb-2">Uploaded Documents:</div>

        <form action="{% url 'extra_work_ticket' changeorder.id %}" id="select_file_form" name ="select_file_form" method="post">
            {% csrf_token %}
            <input type="hidden" id="selected_file" name="selected_file">
        </form>

<ul class="list-unstyled">
    {% for x in foldercontents %}
    <li class="mb-2">

        {% with x|lower as filename %}

        <div class="file-pill"
             onclick="populate_file_form('{{x}}')">

            <span class="file-icon">
                {% if ".pdf" in filename %}
                    üìï
                {% elif ".jpg" in filename or ".jpeg" in filename or ".png" in filename %}
                    üñºÔ∏è
                {% elif ".xls" in filename or ".xlsx" in filename %}
                    üìä
                {% elif ".doc" in filename or ".docx" in filename %}
                    üìò
                {% elif ".zip" in filename %}
                    üóúÔ∏è
                {% else %}
                    üìÑ
                {% endif %}
            </span>

            <span class="file-name">
                {{ x }}
            </span>

        </div>

        {% endwith %}

    </li>
    {% endfor %}
</ul>
    {% endif %}

    {% if can_open_folder %}
    <div class="section-divider"></div>

    <div class="small-note mb-2">Open Change Order Folder</div>

    <input type="text" id="changeOrderPath"
           value="{{ folder_path }}"
           style="position:absolute; left:-9999px;">

    <button type="button"
            class="btn btn-secondary btn-sm"
            onclick="copyChangeOrderPath()">
        üìã Copy Folder Path
    </button>
    {% endif %}

    <div class="section-divider"></div>

    <div class="small-note mb-2">Link Plans to Change Order</div>

    <button type="button"
            class="btn btn-secondary btn-sm"
            data-toggle="modal"
            data-target="#folderSelectModal">
        üìÇ Select Post Bid Docs
    </button>

</div>

<!-- =========================
     NOTES
========================= -->

<div class="clean-card">
    <div class="clean-card-header d-flex justify-content-between align-items-center">
        <span>üìù Notes</span>
        {% if notes|length > 4 %}
        <button class="btn btn-sm btn-outline-secondary"
                type="button"
                data-toggle="collapse"
                data-target="#olderNotes">
            Show Older
        </button>
        {% endif %}
    </div>

    {% if notes %}

        <!-- SHOW 4 MOST RECENT -->
        {% for note in notes|slice:":4" %}
            <div class="small-note mb-2 p-2 border rounded bg-light">
                <strong>{{ note.date }} ‚Äì {{ note.user }}</strong><br>
                {{ note.note }}
            </div>
        {% endfor %}

        <!-- COLLAPSIBLE OLDER NOTES -->
        {% if notes|length > 4 %}
        <div class="collapse mt-2" id="olderNotes">
            {% for note in notes|slice:"4:" %}
                <div class="small-note mb-2 p-2 border rounded">
                    <strong>{{ note.date }} ‚Äì {{ note.user }}</strong><br>
                    {{ note.note }}
                </div>
            {% endfor %}
        </div>
        {% endif %}

    {% else %}
        <div class="small-note mb-2">
            No notes yet.
        </div>
    {% endif %}

    <form name="note_input"
          action="{% url 'extra_work_ticket' changeorder.id %}"
          method="post"
          class="mt-2">
        {% csrf_token %}
        <input type="hidden" name="new_note" id="new_note">
        <button type="button"
                class="btn btn-warning btn-sm"
                onclick="prompt_note()">
            Add Note
        </button>
    </form>

</div>
</div>
</div>
<!--ticket status-->
    {% if changeorder.is_t_and_m %}
<div class="ticket-status-wrapper my-3">
    <div class="ticket-status-centered {{ ticket_status_class }}">
        {{ status }}
    </div>
</div>
    {% endif %}
    <!-- ENTIRE REMAINDER OF PAGE EXCEPT FOOTER-->
<div class="container">
{% if changeorder.is_closed == True %}
    <h1>VOIDED</h1>
{% else %}
<!-- TICKET COLLECTION-->
    {% if changeorder.is_t_and_m == True %}
    {% if changeorder.is_ticket_signed == False%}
        <div>
            <div class="row">

                {% if changeorder.is_t_and_m %}

                <!-- =========================
                     PAPER TICKETS
                ========================== -->
                <div class="col-lg-4 col-md-6 col-12">
                    <div class="ticket-card">
                        <h5>üßæ Paper Tickets</h5>

                        {% if not changeorder.need_ticket %}
                            {% if not changeorder.is_ticket_signed %}
<div>
                                {% if changeorder.digital_ticket_completed %}
                                    <form action="{% url 'print_ticket' changeorder.id 'OLD' %}">
                                        <button type="submit" class="btn btn-outline-secondary btn-sm">
                                            Print T&M Entries for Ink Signature
                                        </button>
                                    </form>
                                {% endif %}
</div>
                                {% if not changeorder.digital_ticket_completed %}

                                {% endif %}



                            {% endif %}
                        {% else %}
                        <div>
                            <form action="{% url 'extra_work_ticket' changeorder.id %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit"
                                            name="oldform"
                                            class="btn btn-outline-secondary btn-sm">
                                        Print Blank T&M Ticket
                                    </button>
                            </form>
                            <form action="{% url 'extra_work_ticket' changeorder.id %}" method="post">
                                {% csrf_token %}
                                <button type="button"
                                        data-toggle="modal"
                                        data-target="#signed_ticket-modal"
                                        class="btn btn-outline-secondary btn-sm">
                                    Paper Ticket Signed
                                </button>
                            </form>
                        </div>
                        {% endif %}

                    </div>
                </div>

                <!-- =========================
                     DIGITAL TICKET ENTRY
                ========================== -->
                <div class="col-lg-4 col-md-6 col-12">
                    <div class="ticket-card">
                        <h5>üíª Digital Ticket Entry</h5>

                        {% if changeorder.need_ticket %}
                            <form action="{% url 'ewt_create' changeorder.id %}">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    Fill Out Ticket Now
                                </button>
                            </form>
                        {% endif %}

                        {% if not changeorder.need_ticket %}
                            {% if changeorder.digital_ticket_completed %}
                                <form action="{% url 'process_ewt' changeorder.id %}">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        View / Change Digital Ticket
                                    </button>
                                </form>
                            {% else %}
                                <form action="{% url 'process_ewt' changeorder.id %}">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        Add Digital Ticket
                                    </button>
                                </form>
                            {% endif %}
                        {% endif %}

                    </div>
                </div>

                <!-- =========================
                     GET SIGNED DIGITALLY
                ========================== -->
                <div class="col-lg-4 col-md-6 col-12">
                    <div class="ticket-card">
                        <h5>‚úçÔ∏è Get Ticket Signed Digitally</h5>

                        {% if not changeorder.need_ticket %}
                            {% if not changeorder.is_ticket_signed %}
                                {% if changeorder.digital_ticket_completed %}

                                    <form action="{% url 'print_ticket' changeorder.id 'NEW' %}">
                                        <button type="submit" class="btn btn-success btn-sm">
                                            Get Digital Signature Now
                                        </button>
                                    </form>

                                    <button type="button"
                                            data-toggle="modal"
                                            data-target="#email_approval_modal"
                                            class="btn btn-outline-success btn-sm">
                                        Email Ticket For Signature
                                    </button>

                                {% endif %}
                            {% endif %}
                        {% endif %}

                    </div>
                </div>

                {% endif %}

            </div>
        </div>
    {% endif %}
    {% endif %}

  <!-- SEND CHANGE ORDER-->

    {% if changeorder.needs_ticket_signed == False %}
<!--    STATUS INDICATOR-->
    <div class="ticket-status-wrapper my-3">
        <div class="ticket-status-centered {{ send_status_class }}">
            {{ send_status }}
        </div>
    </div>
        {% if changeorder.date_sent == None %}
            {% if changeorder.is_t_and_m == True %}
                {% if changeorder.digital_ticket_completed %}
                    <form action="{% url 'price_ewt' changeorder.id %}"><input class="btn btn-primary btn-lg" type="submit"
                                                               value="Send TM Price Now"/></form>
                {% else %}
                    <form action="{% url 'price_old_ewt' changeorder.id %}"><input class="btn btn-primary btn-sm" type="submit"
                                                               value="Send TM Price Now"/></form>
                {% endif %}
            {% else %}
                <form action="{% url 'change_order_send' changeorder.id %}">
                <input class="btn btn-primary btn-sm" type="submit" style="margin-bottom: 5px" value="Send Now"/></form>
            {% endif %}

        {% else %} <!--change order sent-->

            {% if changeorder.is_approved == True %}<!-- 231 been approved -->
                {% if changeorder.is_approved_to_bill == False %}
                <form action="{% url 'batch_approve_co' changeorder.id %}" ><input type="submit" class="btn btn-danger"  value="FORMALLY APPROVE NOW!"/></form>
                {% endif %}
                <h3> Date Sent: {{changeorder.date_sent}}</h3>
                <h3> Date Approved: {{changeorder.date_approved}}</h3>
                <h3>Price: ${{changeorder.price}}</h3>
                <h3>GC #: {{changeorder.gc_number}}</h3>
            {% else %}<!-- 232 not approved -->
                <div class="container" style="margin-bottom: 20px;">
                <b> Date Sent: </b>{{changeorder.date_sent}}
                <br>
                <b>Price: </b>${{changeorder.price}}
                <br>
                <b>Scope: </b><p>{{changeorder.full_description}}</p>
                </div>

                {% if changeorder.is_t_and_m == True %}<!-- 2321 t&m -->
                    <div class="container" style="margin-bottom: 20px;">
                    <div class="row h-100 w-100 d-flex justify-content-left">
                    <div style="padding: 5px" class="form-group">
                    <form action="{% url 'preview_TMProposal' tmproposal.id %}">
                        <input type="submit" class="btn btn-secondary btn-sm" style="margin-bottom: 5px" name="view_proposal" value="Re-Send Proposal"/></form>
                    </div>
                    <div style="padding: 5px" class="form-group">
                    <form action="{% url 'revise_TM_COP' changeorder.id %}">
                        <input type="submit" class="btn btn-secondary btn-sm" style="margin-bottom: 5px" name="view_proposal" value="Revise Proposal"/></form>
                    </div>
                    </div>
                    </div>
                {% else %}<!-- 2322 not t&m -->
                    <div class="container" style="margin-bottom: 20px;">
                    <div class="row h-100 w-100 d-flex justify-content-left">
                    <div style="padding: 5px" class="form-group">
                    <form action="{% url 'change_order_send' changeorder.id %}"><input class="btn btn-secondary btn-sm" type="submit"
                                                                                   name='edit_co'
                                                                                   value="Edit Proposal"/></form>
                    </div>
                    </div>
                    </div>
                {% endif %}<!-- 2321 checking if t&m to know which proposal to show -->


                <form action="{% url 'batch_approve_co' changeorder.id %}" ><input type="submit" class="btn btn-danger"  value="APPROVE NOW!"/></form>
                    <br>

            {% endif %}<!--231 options for been sent-->

    {% endif %}
    {% endif %}<!--22 options-->

{% endif %}<!-- 1 closed or not -->

<br><hr>
</div>
<!--Footer-->
<div class="container-ticket">

<div class="clean-card text-center">

<div class="d-flex flex-wrap justify-content-center">

<form name="change_tm"
      action="{% url 'extra_work_ticket' changeorder.id %}"
      method="post"
      onsubmit="return check_booking_data()"
      class="m-1">
    {% csrf_token %}
    <input type="hidden" id="no_tm" name="no_tm" value="Yes"/>
    <input type="hidden" id="no_tm_notes" name="no_tm_notes" value="None"/>

    {% if changeorder.is_t_and_m %}
        <button class="btn btn-secondary btn-sm">
            Price Required, No Longer T&M
        </button>
    {% else %}
        <button class="btn btn-secondary btn-sm">
            Change to T&M
        </button>
    {% endif %}
</form>

<form name="void_input"
      action="{% url 'extra_work_ticket' changeorder.id %}"
      method="post"
      onsubmit="void_notes1('void_notes')"
      class="m-1">
    {% csrf_token %}
    <input type="hidden" name="void_notes" id="void_notes"/>

    <button class="btn btn-secondary btn-sm">
        {% if changeorder.is_closed %}
            RE-OPEN
        {% else %}
            VOID
        {% endif %}
    </button>
</form>



</div>

</div>
</div>


</div>
{% endblock %}
