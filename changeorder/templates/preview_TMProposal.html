{% extends 'base.html' %}
{% load static %}
{% block nav_item_changeorder %}active{% endblock nav_item_changeorder %}
{% block content %}


<style>
.recipient-row {
    border-bottom: 1px solid #eee;
    padding: 12px 0;
}

#new_contact_fields {
    display: none;
}

.table-responsive {
    overflow-x: auto;
}

.is-invalid {
    border-color: #dc3545 !important;
}

#sending_overlay {
    backdrop-filter: blur(4px);
}
</style>


<!--start date modal-->
<div class="modal fade" id="startdate-modal" tabindex="-1" role="dialog" aria-labelledby="title"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="title3"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                    <label for="selected_file">Select the Extra Work Ticket</label>
                    <select id="selected_file" required class="form-control" name="selected_file" >
                        <option value="please_select">Select The Extra Work Ticket</option>
                        {% if foldercontents %}
                        {% for x in foldercontents %}
                        <option value="{{x}}" class="dropdown-item" >{{x}}</option>
                        {% endfor %}
                        {% endif %}
                    </select>
            </div>


            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="email_now_button" data-dismiss="modal" onclick="selected_file()">Email Now</button>
            </div>
        </div>
    </div>
</div>


<div class="container py-4">
<!--header-->
    <h4 class="mb-2">
        {{changeorder.job_number.job_number}} ‚Äì
        {{changeorder.job_number.job_name}}
    </h4>
<!--header 2-->
    <p class="text-muted">
        Change Order #{{changeorder.cop_number}} ‚Äì
        {{changeorder.description}}
    </p>
<!--recipients-->
    <div class="card shadow-sm mb-4">
<!--        send change order header text-->
        <div class="card-header bg-dark text-white">
            Send Change Order
        </div>

        <div class="card-body">

            <form id="TMProposal_Form"
                  action="{% url 'preview_TMProposal' newproposal.id %}"
                  method="post">

                {% csrf_token %}
                <input type="hidden" id="status" name="status">
                <input type="hidden" id="filename" name="filename">

                <!-- CURRENT RECIPIENTS -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-success text-white">
                        Selected Recipients
                    </div>

                    <div class="card-body">

                        <p class="text-muted small mb-3">
                            These people will receive this change order.
                        </p>

                        {% for x in client_list %}
                        {% if x.current %}
                        <div class="recipient-row row align-items-center">

                            <div class="col-md-3 col-12 mb-2 mb-md-0">
                                <strong>{{x.name}}</strong>
                                {% if x.default %}
                                    <span class="badge badge-light ml-2">
                                        Default
                                    </span>
                                {% endif %}
                            </div>

                        <div class="col-md-4 col-12 mb-2 mb-md-0">

                            <input type="email"
                                   class="form-control existing-email"
                                   value="{{x.email}}"
                                   name="email{{x.person_pk}}"
                                   id="email{{x.person_pk}}">

                            <div class="text-danger small email-error"
                                 style="display:none;">
                                Valid email required.
                            </div>

                            <button type="submit"
                                    name="updateemail{{x.person_pk}}"
                                    id="updatebtn{{x.person_pk}}"
                                    class="btn btn-sm btn-warning mt-2"
                                    style="display:none;">
                                Permanently Update Email
                            </button>

                        </div>

                            <div class="col-md-5 col-12 text-md-right">
                                {% if x.default %}
                                <button type="submit"
                                        name="remove{{x.person_pk}}"
                                        class="btn btn-sm btn-outline-secondary mb-1">
                                    Remove Default
                                </button>
                                {% else %}
                                    <button type="submit"
                                            name="adddefault{{x.person_pk}}"
                                            class="btn btn-sm btn-outline-success mb-1 make-default-existing"
                                            data-toggle="tooltip"
                                            title="This person will automatically receive all future change orders for this project.">
                                        Make Project Default (All Future COs)
                                    </button>
                                {% endif %}

                                <button type="submit"
                                        name="tempremove{{x.person_pk}}"
                                        class="btn btn-sm btn-outline-danger mb-1">
                                    Remove
                                </button>
                            </div>

                        </div>
                        {% endif %}
                        {% endfor %}

                    </div>
                </div>
                <!-- ADD RECIPIENT SECTION -->

                <!--                header text-->
                <div class="text-center my-4">
                    <hr>
                    <h6 class="text-muted">Add Additional Recipients</h6>
                </div>
                <!--add new recipient-->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light">
                        Add Recipient
                    </div>

                    <div class="card-body">

                        <p class="text-muted small mb-3">
                            Search for an existing contact or type a new name to add someone.
                        </p>

                        <div class="row align-items-end">

                            <div class="col-md-5 col-12 mb-3 mb-md-0">
                                <label class="small text-muted">
                                    Search or Type New Name
                                </label>

                                <select name="addrecipient"
                                        id="addrecipient"
                                        class="form-control">
                                    <option></option>
                                    {% for x in client_list %}
                                        {% if not x.current %}
                                        <option value="{{x.person_pk}}">
                                            {{x.name}}
                                        </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <div id="addrecipient_error"
                                     class="text-danger small mt-1"
                                     style="display:none;">
                                    Please select or type a recipient.
                                </div>
                            </div>

                            <div class="col-md-4 col-12"
                                 id="new_contact_fields"
                                 style="display:none;">

                                <label class="small text-muted">
                                    Email for New Contact
                                </label>

                                <input type="email"
                                       id="new_contact_email"
                                       name="new_contact_email"
                                       class="form-control">

                                <div id="new_contact_email_error"
                                     class="text-danger small mt-1"
                                     style="display:none;">
                                    Valid email required.
                                </div>

                                <div class="alert alert-warning small mt-2 py-2"
                                     id="new_contact_warning"
                                     style="display:none;">
                                    This person will be added to
                                    <strong>{{changeorder.job_number.client}}</strong>.
                                </div>

                            </div>

                            <div class="col-md-3 col-12 text-md-right mt-3 mt-md-0">
                                <button type="submit"
                                        name="defaultadd{{x.person_pk}}"
                                        class="btn btn-sm btn-outline-success mb-1 make-default-new"
                                        data-toggle="tooltip"
                                        title="This person will automatically receive all future change orders for this project.">
                                    Make Project Default (All Future COs)
                                </button>

                                <button type="submit"
                                        name="tempadd"
                                        class="btn btn-outline-primary btn-block">
                                    Add to Ticket
                                </button>
                            </div>

                        </div>

                    </div>
                </div>

                <!-- FINAL ACTION -->
                <div class="text-right mt-3">
                    <button type="submit"
                            name="no_email"
                            class="btn btn-secondary">
                        Don‚Äôt Email
                    </button>

                    <button type="button"
                            class="btn btn-primary"
                            data-toggle="modal"
                            data-target="#startdate-modal">
                        Send Email With Proposal
                    </button>
                </div>

            </form>
    <!-- Sending Proposal Overlay -->
<div id="sending_overlay"
     style="
        display:none;
        position:fixed;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background:rgba(0,0,0,0.75);
        color:white;
        z-index:9999;
        text-align:center;
        padding-top:20%;
     ">

    <div class="spinner-border text-light"
         role="status"
         style="width:4rem;height:4rem;">
    </div>

    <h3 class="mt-4 font-weight-bold">
        Sending Proposal‚Ä¶
    </h3>

    <p class="mt-3" style="font-size:1.1rem; font-weight:500;">
        Please do not click anything.
    </p>

</div>
        </div>
    </div>

</div>

<script>

    $(function () {

        // --------------------------------------------------
    // Show "Permanently Update Email" when changed
    // --------------------------------------------------
    $(".existing-email").on("input", function () {

        const $input = $(this);
        const original = $input.data("original");
        const current = $input.val();

        const pk = this.id.replace("email", "");
        const $button = $("#updatebtn" + pk);

        if (current !== original) {
            $button.show();
        } else {
            $button.hide();
        }

    });

    // --------------------------------------------------
    // Tooltips
    // --------------------------------------------------
    $('[data-toggle="tooltip"]').tooltip({
        container: 'body'
    });

    // --------------------------------------------------
    // Track clicked submit button
    // --------------------------------------------------
    let clickedButton = null;

    $("#TMProposal_Form button[type='submit']").on("click", function () {
        clickedButton = this;
    });

    // --------------------------------------------------
    // Select2 Setup
    // --------------------------------------------------
    $('#addrecipient').select2({
        placeholder: "Search or type new contact",
        allowClear: true,
        tags: true,
        width: '100%'
    });

    $('#addrecipient').on('select2:select', function (e) {
        let val = e.params.data.id;

        if ($.isNumeric(val)) {
            $('#new_contact_fields').hide();
            $('#new_contact_warning').hide();
            $('#new_contact_email').val('');
        } else {
            $('#new_contact_fields').show();
            $('#new_contact_warning').show();
            $('#new_contact_email').focus();
        }
    });

    $('#addrecipient').on('select2:clear', function () {
        $('#new_contact_fields').hide();
        $('#new_contact_warning').hide();
        $('#new_contact_email').val('');
    });

    // --------------------------------------------------
    // Main Form Submit Logic
    // --------------------------------------------------
    $("#TMProposal_Form").on("submit", function (e) {

        if (!clickedButton) return;

        const name = clickedButton.name || "";
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        // =============================================
        // 1Ô∏è‚É£ UPDATE EMAIL BUTTON
        // =============================================
        if (name.startsWith("updateemail")) {

            const pk = name.replace("updateemail", "");
            const $input = $("#email" + pk);
            const email = $input.val().trim();

            if (!email || !emailPattern.test(email)) {
                e.preventDefault();
                $input.addClass("is-invalid");
                $input.next(".email-error").show();
                return false;
            }

            return; // allow submission
        }

        // =============================================
        // 2Ô∏è‚É£ REMOVE BUTTONS ‚Üí skip validation
        // =============================================
        if (name.startsWith("tempremove") || name.startsWith("remove")) {
            return;
        }

        // =============================================
        // 3Ô∏è‚É£ Bottom Add Buttons
        // =============================================
        if ($(clickedButton).hasClass("make-default-new") || name === "tempadd") {

            const selected = $("#addrecipient").val();

            if (!selected) {
                e.preventDefault();
                $("#addrecipient_error").show();
                return false;
            }

            $("#addrecipient_error").hide();

            if ($("#new_contact_fields").is(":visible")) {

                const newEmail = $("#new_contact_email").val().trim();

                if (!newEmail || !emailPattern.test(newEmail)) {
                    e.preventDefault();
                    $("#new_contact_email").addClass("is-invalid");
                    $("#new_contact_email_error").show();
                    return false;
                }
            }

            return;
        }

        // =============================================
        // 4Ô∏è‚É£ Everything Else ‚Üí Allow
        // =============================================
        return;

    });

});


// --------------------------------------------------
// Proposal Send (Modal Button)
// --------------------------------------------------
function showSendingOverlay() {
    $("#sending_overlay").fadeIn(200);
}

function selected_file() {

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    let isValid = true;

    $(".existing-email").each(function () {

        let $input = $(this);
        let email = $input.val().trim();

        if (!email || !emailPattern.test(email)) {
            isValid = false;
            $input.addClass("is-invalid");
            $input.next(".email-error").show();
        } else {
            $input.removeClass("is-invalid");
            $input.next(".email-error").hide();
        }
    });

    if (!isValid) return;

    showSendingOverlay();

    const form = document.getElementById("TMProposal_Form");

    form.filename.value =
        document.getElementById("selected_file").value;

    form.status.value = "Final";

    form.requestSubmit();   // üî• use this instead
}
</script>
{% endblock %}